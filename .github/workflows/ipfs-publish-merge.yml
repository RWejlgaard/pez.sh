# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to ipfs servers on merge
'on':
  push:
    branches:
      - master
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Deploy to IPFS servers
        run: |
          mkdir -p ~/.ssh
          echo ${{ secrets.SSH_KEY }} | tee ~/.ssh/id_rsa
          cd ${{ github.workspace }}
          ./deploy-ipfs.sh
      - name: Update cloudflare
        run: |
          mkdir -p ~/.ssh
          echo ${{ secrets.SSH_KEY }} > ~/.ssh/id_rsa
          export IPFS_HASH=`ipfs add -r public | tail -n 1 | cut -d " " -f 2`
          curl -X PUT 'https://api.cloudflare.com/client/v4/zones/d039e5e29c80ee293666f668ba687fe7/dns_records/d844791452369bbdc8d7445a2c616791' \
          -H 'X-Auth-Email: ${{ secrets.CLOUDFLARE_EMAIL }}' \
          -H 'X-Auth-Key: ${{ secrets.CLOUDFLARE_API_KEY }}' \
          -H 'Content-type: application/json' \
          --data '{"type": "TXT", "name": "_dnslink.pez.sh", "content": "dnslink=/ipfs/${IPFS_HASH}" }'
          curl -X PUT 'https://api.cloudflare.com/client/v4/zones/d039e5e29c80ee293666f668ba687fe7/dns_records/f61163333ec6ea593d7b3b6b567ad55c' \
          -H 'X-Auth-Email: ${{ secrets.CLOUDFLARE_EMAIL }}' \
          -H 'X-Auth-Key: ${{ secrets.CLOUDFLARE_API_KEY }}' \
          -H 'Content-type: application/json' \
          --data '{"type": "TXT", "name": "_dnslink.ipfs.pez.sh", "content": "dnslink=/ipfs/${IPFS_HASH}" }'


